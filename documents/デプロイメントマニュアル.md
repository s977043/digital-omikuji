# デプロイメントマニュアル

## 概要

digital-omikuji プロジェクトのデプロイメント手順について説明します。VibeCoding と Gemini CLI を使用した自動化されたデプロイメントプロセスを含みます。

## 前提条件

- Docker および Docker Compose がインストール済み
- VibeCoding と Gemini CLI が設定済み
- 必要な環境変数が設定済み
- Git リポジトリへのアクセス権限

## 本番環境の準備

### 1. 環境変数の設定

本番環境用の `.env.production` ファイルを作成：

```bash
# 本番環境設定
NODE_ENV=production
PORT=3000

# Gemini CLI 設定
GEMINI_API_KEY=production-api-key-here

# VibeCoding 設定
VIBE_PROJECT_ID=digital-omikuji-production
VIBE_WORKSPACE=/app

# セキュリティ設定
SESSION_SECRET=your-session-secret-here
CORS_ORIGIN=https://your-domain.com
```

### 2. Docker イメージの最適化

`Dockerfile.production` を作成：

```dockerfile
# Multi-stage build for production
FROM node:18-alpine AS builder

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci --only=production

# Copy source code
COPY . .

# Build the application
RUN npm run build

# Production stage
FROM node:18-alpine AS production

# Security: Create non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

WORKDIR /app

# Copy built application
COPY --from=builder --chown=nextjs:nodejs /app/build ./build
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/package*.json ./

# Install only production dependencies
RUN npm ci --only=production && npm cache clean --force

# Switch to non-root user
USER nextjs

EXPOSE 3000

CMD ["npm", "run", "start"]
```

### 3. Docker Compose 本番設定

`docker-compose.production.yml` を作成：

```yaml
version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.production
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env.production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

## デプロイメント手順

### 1. 手動デプロイメント

```bash
# 1. プロジェクトの最新版を取得
git pull origin main

# 2. 依存関係をインストール
npm install

# 3. アプリケーションをビルド
npm run build

# 4. 本番環境用イメージをビルド
docker-compose -f docker-compose.production.yml build

# 5. サービスを起動
docker-compose -f docker-compose.production.yml up -d

# 6. デプロイメントの確認
docker-compose -f docker-compose.production.yml ps
```

### 2. VibeCoding を使用した自動デプロイメント

#### VibeCoding デプロイメント設定

`.vibe-deploy.json` を作成：

```json
{
  "deployment": {
    "strategy": "blue-green",
    "environment": "production",
    "healthCheck": {
      "url": "http://localhost:3000/health",
      "timeout": 30,
      "retries": 3
    },
    "rollback": {
      "enabled": true,
      "trigger": "health-check-failure"
    }
  },
  "build": {
    "command": "npm run build",
    "dockerfile": "Dockerfile.production",
    "context": "."
  },
  "deploy": {
    "command": "docker-compose -f docker-compose.production.yml up -d",
    "timeout": 300
  },
  "postDeploy": {
    "healthCheck": true,
    "notification": {
      "enabled": true,
      "webhook": "https://your-webhook-url.com"
    }
  }
}
```

#### デプロイメント実行

```bash
# VibeCoding を使用したデプロイメント
vibe deploy --config .vibe-deploy.json --env production

# ログの確認
vibe deploy logs --tail 100

# ロールバック（必要に応じて）
vibe deploy rollback --version previous
```

### 3. Gemini CLI を使用したデプロイメント支援

#### デプロイメント前のチェック

```bash
# コード品質チェック
gemini review --project --severity error

# セキュリティチェック
gemini security scan --path .

# パフォーマンスチェック
gemini performance analyze --build-output build/
```

#### デプロイメント設定の生成

```bash
# Nginx 設定の生成
gemini generate config --type nginx --domain your-domain.com

# SSL 証明書設定の生成
gemini generate ssl-config --domain your-domain.com --provider letsencrypt

# 環境変数テンプレートの生成
gemini generate env --template production --output .env.production.template
```

## 継続的デプロイメント (CI/CD)

### GitHub Actions 設定

`.github/workflows/deploy.yml` を作成：

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm test
        
      - name: Run Gemini CLI review
        run: |
          npm install -g @google-ai/generative-ai-cli
          gemini review --project --ci
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Docker
        uses: docker/setup-buildx-action@v2
        
      - name: Build and deploy
        run: |
          docker-compose -f docker-compose.production.yml build
          docker-compose -f docker-compose.production.yml up -d
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
      - name: Health check
        run: |
          sleep 30
          curl -f http://localhost:3000/health
```

## 監視とメンテナンス

### 1. ヘルスチェック

アプリケーションに `/health` エンドポイントを追加：

```typescript
// app/routes/health.tsx
export async function loader() {
  return json({ 
    status: 'OK',
    timestamp: new Date().toISOString(),
    version: process.env.npm_package_version
  });
}
```

### 2. ログ監視

```bash
# アプリケーションログの確認
docker-compose -f docker-compose.production.yml logs -f web

# システムリソースの監視
docker stats
```

### 3. 定期的なメンテナンス

```bash
# Docker システムのクリーンアップ
docker system prune -f

# 未使用のイメージを削除
docker image prune -f

# ログローテーション
docker-compose -f docker-compose.production.yml exec web logrotate /etc/logrotate.conf
```

## バックアップと復元

### 1. データベースバックアップ（必要に応じて）

```bash
# データベースバックアップ
docker-compose -f docker-compose.production.yml exec db mysqldump -u root -p database_name > backup.sql

# 復元
docker-compose -f docker-compose.production.yml exec db mysql -u root -p database_name < backup.sql
```

### 2. 設定ファイルのバックアップ

```bash
# 重要な設定ファイルをバックアップ
tar -czf config-backup-$(date +%Y%m%d).tar.gz .env.production docker-compose.production.yml nginx.conf
```

## セキュリティ対策

### 1. SSL/TLS 設定

```bash
# Let's Encrypt 証明書の取得
certbot certonly --webroot -w /var/www/html -d your-domain.com

# 証明書の自動更新
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
```

### 2. ファイアウォール設定

```bash
# 必要なポートのみ開放
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

## トラブルシューティング

### デプロイメント失敗時の対処

```bash
# ログの確認
docker-compose -f docker-compose.production.yml logs

# コンテナの状態確認
docker-compose -f docker-compose.production.yml ps

# サービスの再起動
docker-compose -f docker-compose.production.yml restart web
```

### ロールバック手順

```bash
# 前のバージョンに戻す
git checkout HEAD~1
docker-compose -f docker-compose.production.yml build
docker-compose -f docker-compose.production.yml up -d
```

## 参考資料

- [Docker 本番環境ベストプラクティス](https://docs.docker.com/develop/dev-best-practices/)
- [Remix デプロイメントガイド](https://remix.run/docs/en/main/guides/deployment)
- [Node.js 本番環境設定](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)