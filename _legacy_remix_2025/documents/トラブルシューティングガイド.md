# トラブルシューティングガイド

## 概要

digital-omikuji プロジェクトの開発中に発生する可能性のある問題とその解決方法について説明します。

## 環境設定関連

### Node.js / npm 関連

#### 問題: `npm install` が失敗する
```bash
npm ERR! code EACCES
npm ERR! syscall access
npm ERR! path /usr/local/lib/node_modules
```

**解決方法:**
```bash
# 権限の問題を解決
sudo chown -R $(whoami) ~/.npm
sudo chown -R $(whoami) /usr/local/lib/node_modules

# または、nvm を使用してNode.jsを管理
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18
```

#### 問題: `npm run dev` でポートが使用中エラー
```bash
Error: listen EADDRINUSE: address already in use :::3000
```

**解決方法:**
```bash
# ポートを使用しているプロセスを確認
lsof -i :3000

# プロセスを終了
kill -9 <PID>

# または、別のポートを使用
PORT=3001 npm run dev
```

### Docker 関連

#### 問題: Docker コンテナが起動しない
```bash
ERROR: Couldn't connect to Docker daemon at http+docker://localhost
```

**解決方法:**
```bash
# Docker サービスの状態確認
sudo systemctl status docker

# Docker サービスの開始
sudo systemctl start docker

# ユーザーをdockerグループに追加
sudo usermod -aG docker $USER
```

#### 問題: Docker イメージのビルドが失敗する
```bash
ERROR: failed to solve: process "/bin/sh -c npm install" did not complete successfully
```

**解決方法:**
```bash
# Docker キャッシュをクリア
docker builder prune

# 強制的に再ビルド
docker-compose build --no-cache

# .dockerignore を確認
echo "node_modules" >> .dockerignore
echo "build" >> .dockerignore
```

## VibeCoding 関連

### 設定エラー

#### 問題: `.vibeconfig.json` が認識されない
```bash
Error: VibeCoding configuration not found
```

**解決方法:**
```bash
# 設定ファイルの場所を確認
ls -la .vibeconfig.json

# 設定ファイルの権限を確認
chmod 644 .vibeconfig.json

# 設定ファイルの妥当性を検証
vibe config validate
```

#### 問題: 環境変数が読み込まれない
```bash
Error: GEMINI_API_KEY is not defined
```

**解決方法:**
```bash
# 環境変数を確認
echo $GEMINI_API_KEY

# .env.local ファイルを作成
echo "GEMINI_API_KEY=your-api-key-here" > .env.local

# 環境変数を直接設定
export GEMINI_API_KEY=your-api-key-here
```

## Gemini CLI 関連

### 認証エラー

#### 問題: API キーが無効
```bash
Error: Invalid API key provided
```

**解決方法:**
```bash
# API キーを確認
gemini config get api-key

# 新しいAPI キーを設定
gemini config set api-key new-valid-api-key

# Google AI Studio で新しいキーを生成
# https://aistudio.google.com/app/apikey
```

### レート制限エラー

#### 問題: API リクエストが多すぎる
```bash
Error: Rate limit exceeded. Please try again later.
```

**解決方法:**
```bash
# リクエスト間隔を設定
gemini config set rate-limit 2000

# バッチ処理の並列数を制限
gemini batch --concurrency 1

# 待機時間を設定
sleep 5 && gemini generate component
```

## アプリケーション固有の問題

### Remix 関連

#### 問題: ビルドエラー
```bash
Error: Cannot resolve module 'some-module'
```

**解決方法:**
```bash
# 依存関係を再インストール
rm -rf node_modules package-lock.json
npm install

# TypeScript の型定義を確認
npm install --save-dev @types/node @types/react @types/react-dom

# remix.config.js を確認
```

#### 問題: Hot Reload が動作しない
```bash
# 開発サーバーを再起動
npm run dev

# キャッシュをクリア
rm -rf build .cache

# ポートを変更
PORT=3001 npm run dev
```

### テスト関連

#### 問題: Jest テストが失敗する
```bash
Error: Test suite failed to run
```

**解決方法:**
```bash
# Jest 設定を確認
npx jest --init

# テスト用の依存関係をインストール
npm install --save-dev @testing-library/react @testing-library/jest-dom

# テストファイルの構文を確認
npx jest --verbose
```

## パフォーマンス問題

### メモリ使用量が多い

#### 問題: Node.js プロセスのメモリ使用量が多い
```bash
# メモリ使用量を確認
ps aux | grep node

# ヒープサイズを制限
NODE_OPTIONS="--max-old-space-size=4096" npm run dev

# メモリリークを確認
node --inspect npm run dev
```

### ビルド時間が長い

#### 問題: npm run build が遅い
```bash
# 依存関係の分析
npm ls --depth=0

# 不要な依存関係を削除
npm uninstall unused-package

# 並列ビルドを有効化
npm run build -- --parallel
```

## デバッグ手法

### 1. ログの確認

```bash
# アプリケーションログ
tail -f logs/app.log

# Docker コンテナのログ
docker-compose logs -f web

# システムログ
journalctl -u docker
```

### 2. 詳細なエラー情報の取得

```bash
# デバッグモードでの実行
DEBUG=* npm run dev

# 詳細なスタックトレース
NODE_ENV=development npm run dev
```

### 3. 設定の検証

```bash
# VibeCoding 設定の検証
vibe config validate

# Gemini CLI 設定の検証
gemini config list

# 環境変数の確認
env | grep -E "(GEMINI|VIBE|NODE)"
```

## 緊急時の対応

### 1. プロジェクトの初期化

```bash
# 全ての生成ファイルを削除
rm -rf node_modules build .cache

# 依存関係の再インストール
npm install

# 設定ファイルの再作成
cp .vibeconfig.json.backup .vibeconfig.json
```

### 2. バックアップからの復元

```bash
# Git から最新の安定版を取得
git checkout main
git pull origin main

# 設定ファイルを復元
git checkout HEAD -- .vibeconfig.json .env.local
```

## サポート情報

### 問題報告時に含める情報

1. エラーメッセージの全文
2. 使用している Node.js バージョン (`node --version`)
3. 使用している npm バージョン (`npm --version`)
4. OS 情報 (`uname -a`)
5. 実行したコマンド
6. 期待していた結果と実際の結果

### 参考リンク

- [Remix トラブルシューティング](https://remix.run/docs/en/main/guides/troubleshooting)
- [Docker トラブルシューティング](https://docs.docker.com/engine/troubleshooting/)
- [Node.js トラブルシューティング](https://nodejs.org/en/docs/guides/debugging-getting-started/)